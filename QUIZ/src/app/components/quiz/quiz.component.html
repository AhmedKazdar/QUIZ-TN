<!-- Quiz Results Section for Online Mode -->
<div class="quiz-container" *ngIf="quizFinished && quizResult && mode === 'online'">
  <div class="quiz-result-card">
    <!-- Winner Celebration for Online Mode -->
    <div class="winner-celebration mb-4">
      <div *ngIf="isWinner" class="alert alert-success text-center">
        <i class="bi bi-trophy-fill me-2" style="font-size: 2rem;"></i>
        <h3 class="mb-2">üèÜ You Won! üèÜ</h3>
        <p class="mb-0">Congratulations! You are the champion!</p>
      </div>
      <div *ngIf="gameWinner && !isWinner" class="alert alert-info text-center">
        <i class="bi bi-flag-fill me-2"></i>
        <h4 class="mb-2">Game Over</h4>
        <p class="mb-1"><strong>Winner:</strong> {{ gameWinner.username }}</p>
        <p class="mb-0">Better luck next time!</p>
      </div>
      <div *ngIf="!gameWinner" class="alert alert-warning text-center">
        <i class="bi bi-emoji-neutral me-2"></i>
        <h4 class="mb-2">Game Over - It's a Draw!</h4>
        <p class="mb-0">No one answered the final question correctly.</p>
      </div>
    </div>

    <!-- Score and details for all players -->
    <div>
      <!-- Results Header -->
      <div class="result-header" [ngClass]="getScoreClass(quizResult?.score || 0)">
        <h2 *ngIf="!isWinner">Game Over!</h2>
        <h2 *ngIf="isWinner">You're the Winner!</h2>
        <p>Your Score: {{ quizResult?.score || 0 }}%</p>
      </div>
      
      <!-- Score Display -->
      <div class="result-score">
        <div class="score-circle" [ngClass]="getScoreClass(quizResult?.score || 0)">
          <span class="score-value">{{ quizResult?.score || 0 }}%</span>
          <div class="score-circle-bg"></div>
          <svg class="score-circle-chart" viewBox="0 0 36 36">
            <path class="score-circle-bg"
                  d="M18 2.0845
                     a 15.9155 15.9155 0 0 1 0 31.831
                     a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke="#eee"
                  stroke-width="3"/>
            <path class="score-circle-fill"
                  d="M18 2.0845
                     a 15.9155 15.9155 0 0 1 0 31.831
                     a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  [attr.stroke-dasharray]="(quizResult?.score || 0) + ',100'"
                  stroke="currentColor"
                  stroke-width="3"/>
          </svg>
        </div>
      </div>

      <!-- Result Details -->
      <div class="result-details">
        <div class="result-detail">
          <div class="detail-label">Correct Answers</div>
          <div class="detail-value correct">{{ quizResult?.correctAnswers || 0 }} / {{ quizResult?.totalQuestions || 0 }}</div>
        </div>
        <div class="result-detail">
          <div class="detail-label">Incorrect Answers</div>
          <div class="detail-value incorrect">{{ (quizResult?.totalQuestions || 0) - (quizResult?.correctAnswers || 0) }} / {{ quizResult?.totalQuestions || 0 }}</div>
        </div>
        <div class="result-detail">
          <div class="detail-label">Time Spent</div>
          <div class="detail-value">{{ quizResult?.timeSpent || 0 }} seconds</div>
        </div>
      </div>
      
      <div class="result-mode">
        <i class="bi bi-trophy-fill me-2"></i>
        <span *ngIf="isWinner">You've topped the leaderboard!</span>
        <span *ngIf="!isWinner">Your score has been submitted to the leaderboard!</span>
      </div>
    </div>
    
    <div class="result-actions">
      <button class="btn btn-primary me-2" type="button" (click)="restartQuiz()">
        <i class="bi bi-arrow-repeat me-2"></i>Try Again
      </button>
      <button class="btn btn-outline-secondary" type="button" (click)="navigateToHome()">
        <i class="bi bi-house-door me-2"></i>Back to Home
      </button>
    </div>
  </div>
</div>

<!-- Quiz Results Section for Solo Mode -->
<div class="quiz-container" *ngIf="quizFinished && quizResult && mode === 'solo'">
  <div class="quiz-result-card">
    <!-- Score Reveal Section -->
    <div class="result-header" [ngClass]="getScoreClass(quizResult?.score || 0)">
      <h2>Quiz Completed!</h2>
      <p>Your Final Score: {{ quizResult?.score || 0 }}%</p>
    </div>
    
    <!-- Score Display -->
    <div class="result-score">
      <div class="score-circle" [ngClass]="getScoreClass(quizResult?.score || 0)">
        <span class="score-value">{{ quizResult?.score || 0 }}%</span>
        <div class="score-circle-bg"></div>
        <svg class="score-circle-chart" viewBox="0 0 36 36">
          <path class="score-circle-bg"
                d="M18 2.0845
                   a 15.9155 15.9155 0 0 1 0 31.831
                   a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke="#eee"
                stroke-width="3"/>
          <path class="score-circle-fill"
                d="M18 2.0845
                   a 15.9155 15.9155 0 0 1 0 31.831
                   a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                [attr.stroke-dasharray]="(quizResult?.score || 0) + ',100'"
                stroke="currentColor"
                stroke-width="3"/>
        </svg>
      </div>
    </div>

    <!-- Result Details -->
    <div class="result-details">
      <div class="result-detail">
        <div class="detail-label">Correct Answers</div>
        <div class="detail-value correct">{{ quizResult?.correctAnswers || 0 }} / {{ quizResult?.totalQuestions || 0 }}</div>
      </div>
      <div class="result-detail">
        <div class="detail-label">Incorrect Answers</div>
        <div class="detail-value incorrect">{{ (quizResult?.totalQuestions || 0) - (quizResult?.correctAnswers || 0) }} / {{ quizResult?.totalQuestions || 0 }}</div>
      </div>
      <div class="result-detail">
        <div class="detail-label">Time Spent</div>
        <div class="detail-value">{{ quizResult?.timeSpent || 0 }} seconds</div>
      </div>
    </div>
    
    <!-- Performance Message -->
    <div class="result-mode" [ngClass]="getScoreClass(quizResult?.score || 0)">
      <i class="bi" [ngClass]="{
        'bi-emoji-smile-fill': (quizResult?.score || 0) >= 80,
        'bi-emoji-neutral-fill': (quizResult?.score || 0) >= 50 && (quizResult?.score || 0) < 80,
        'bi-emoji-frown-fill': (quizResult?.score || 0) < 50
      }"></i>
      <span>
        <span *ngIf="(quizResult?.score || 0) >= 80">Excellent! You're a quiz master! üéâ</span>
        <span *ngIf="(quizResult?.score || 0) >= 50 && (quizResult?.score || 0) < 80">Good job! Keep practicing! üëç</span>
        <span *ngIf="(quizResult?.score || 0) < 50">Nice try! Practice makes perfect! üí™</span>
      </span>
    </div>
    
    <div class="result-actions">
      <button class="btn btn-primary me-2" type="button" (click)="restartQuiz()">
        <i class="bi bi-arrow-repeat me-2"></i>Try Again
      </button>
      <button class="btn btn-outline-secondary" type="button" (click)="navigateToHome()">
        <i class="bi bi-house-door me-2"></i>Back to Home
      </button>
    </div>
  </div>
</div>

<!-- Active Quiz Section -->
<div class="quiz-container" *ngIf="quizStarted && !quizFinished">
  <div class="quiz-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">
        <span *ngIf="mode === 'solo'">Solo Quiz</span>
        <span *ngIf="mode === 'online'">Online Quiz</span>
      </h2>
    </div>
    
    <div class="quiz-header">
      <div class="quiz-progress">
        <div class="progress">
          <div class="progress-bar" 
               [style.width]="currentProgress + '%'"
               role="progressbar" 
               [attr.aria-valuenow]="currentQuestionIndex + 1" 
               aria-valuemin="0" 
               [attr.aria-valuemax]="ariaValueMax">
          </div>
        </div>
        <div class="question-counter">
          Question {{ currentQuestionIndex + 1 }} of {{ totalQuestionsCount }}
        </div>
      </div>
      <div class="d-flex align-items-center">
        <!-- Timer for online mode -->
        <div class="quiz-timer me-3" *ngIf="mode === 'online'" [ngClass]="{
          'text-warning': timeRemaining <= 15 && timeRemaining > 5,
          'text-danger': timeRemaining <= 5
        }">
          <i class="bi bi-clock-history me-1"></i>
          Q{{ currentQuestionIndex + 1 }}: {{ timeRemaining | number:'2.0-0' }}s
        </div>
        
        <div class="quiz-mode-badge" [ngClass]="mode === 'solo' ? 'solo' : 'online'">
          {{ mode === 'solo' ? 'Solo Mode' : 'Online Mode' }}
        </div>
      </div>
    </div>
    
    <div class="question-container" *ngIf="questions[currentQuestionIndex]">
      <!-- Watch mode message when user is eliminated but not from timeout -->
      <div class="alert alert-warning" *ngIf="watchMode && !error" role="alert">
        <div class="d-flex align-items-center">
          <i class="bi bi-eye-fill me-2"></i>
          <div>
            <h5 class="alert-heading mb-1">Watch Mode Activated</h5>
            <p class="mb-0">You've been eliminated. You can continue watching the quiz but can no longer participate.</p>
          </div>
        </div>
      </div>

      <!-- Time's up message - Different messages for final vs regular questions -->
      <div class="alert alert-info" *ngIf="mode === 'online' && timeRemaining <= 0 && !quizFinished" role="alert">
        <div class="d-flex align-items-center">
          <i class="bi bi-clock-fill me-2"></i>
          <div>
            <h5 class="alert-heading mb-1" *ngIf="currentQuestionIndex === questions.length - 1">
              Time's Up! Determining Winner...
            </h5>
            <h5 class="alert-heading mb-1" *ngIf="currentQuestionIndex < questions.length - 1">
              Time's Up! Proceeding to next question...
            </h5>
            <p class="mb-0" *ngIf="currentQuestionIndex === questions.length - 1">
              Final question completed. Calculating results...
            </p>
            <p class="mb-0" *ngIf="currentQuestionIndex < questions.length - 1">
              Please wait while we proceed to the next question.
            </p>
          </div>
        </div>
      </div>
      
      <h3 class="question-text">{{ questions[currentQuestionIndex].question }}</h3>
      
      <!-- Waiting message for online mode -->
      <div *ngIf="mode === 'online' && waitingForAnswer" class="waiting-container text-center my-4">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <h4>Waiting for other players...</h4>
      </div>
      
      <!-- OPTIONS CONTAINER - UPDATED FOR SOLO MODE FEEDBACK -->
      <div class="options-container" [class.waiting]="mode === 'online' && waitingForAnswer">
        <div *ngFor="let option of questions[currentQuestionIndex].options; let i = index" 
             class="option" 
             [class.selected]="selectedAnswer === i"
             [class.answered]="answers[currentQuestionIndex] !== null && answers[currentQuestionIndex] !== undefined"
             [class.correct]="(mode === 'solo' && showAnswerFeedback && option.isCorrect) || 
                             (mode === 'online' && ((timeRemaining <= 0 && option.isCorrect) || (watchMode && timeRemaining <= 0 && option.isCorrect)))"
             [class.incorrect]="(mode === 'solo' && showAnswerFeedback && selectedAnswer === i && !option.isCorrect) ||
                               (mode === 'online' && timeRemaining <= 0 && selectedAnswer === i && !option.isCorrect)"
             [class.disabled]="(mode === 'solo' && showAnswerFeedback) || watchMode || timeRemaining <= 0"
             (click)="!watchMode && timeRemaining > 0 && !(mode === 'solo' && showAnswerFeedback) && selectAnswer(i)">
          
          <div class="option-letter">{{ getLetter(i) }}</div>
          <div class="option-text">{{ option.text }}</div>
          
          <!-- Answer feedback for solo mode -->
          <div class="answer-feedback" *ngIf="mode === 'solo' && showAnswerFeedback">
            <i class="bi" [ngClass]="{
              'bi-check-circle-fill text-success': option.isCorrect,
              'bi-x-circle-fill text-danger': selectedAnswer === i && !option.isCorrect
            }"></i>
          </div>
          
          <!-- Answer feedback for online mode -->
          <div class="answer-feedback" *ngIf="mode === 'online' && ((timeRemaining <= 0 && selectedAnswer !== null && !waitingForAnswer) || quizFinished || (watchMode && timeRemaining <= 0))">
            <i class="bi" [ngClass]="{
              'bi-check-circle-fill text-success': option.isCorrect,
              'bi-x-circle-fill text-danger': selectedAnswer === i && !option.isCorrect
            }"></i>
          </div>
          
          <!-- Watch mode indicator -->
          <div class="watch-mode-overlay" *ngIf="watchMode && timeRemaining > 0">
            <i class="bi bi-eye"></i>
            <span>View Only</span>
          </div>
        </div>
      </div>

      <!-- Correct answer message for solo mode -->
      <div *ngIf="mode === 'solo' && showAnswerFeedback && currentCorrectAnswerIndex !== null && questions[currentQuestionIndex]" class="correct-answer-message">
        <p *ngIf="selectedAnswer !== currentCorrectAnswerIndex">
          Correct answer: {{ getLetter(currentCorrectAnswerIndex) }}. {{ questions[currentQuestionIndex].options[currentCorrectAnswerIndex]?.text }}
        </p>
        <p *ngIf="selectedAnswer === currentCorrectAnswerIndex" class="text-success">
          ‚úÖ Correct! Well done!
        </p>
      </div>
    </div>
    
   <!--  <div class="quiz-actions">
      
      <button *ngIf="mode === 'solo'" 
              class="btn btn-primary" 
              (click)="nextQuestion()" 
              [disabled]="selectedAnswer === null || loading">
        <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
        {{ currentQuestionIndex === questions.length - 1 ? 'Finish Quiz' : 'Next Question' }}
        <i class="bi bi-arrow-right ms-2"></i>
      </button>
    </div> -->
  </div>
</div>

<!-- Global Error Display -->
<div *ngIf="error && !quizStarted && !quizFinished" class="alert alert-danger" role="alert">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  {{ error }}
</div>