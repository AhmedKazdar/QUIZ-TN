<!-- Quiz Results Section for Online Mode -->
<div class="quiz-container" *ngIf="quizFinished && mode === 'online'">
  <div class="quiz-result-card">
    <!-- Fastest Winner Celebration -->
    <div class="winner-celebration mb-4" *ngIf="gameWinner">
      <div class="alert alert-success text-center" *ngIf="isWinner">
        <i class="bi bi-trophy-fill me-2" style="font-size: 3rem;"></i>
        <h2 class="mb-3">üèÜ YOU WIN! üèÜ</h2>
        <h4 class="mb-2">Congratulations! You answered the final question first!</h4>
        <p class="mb-1">Time: {{ gameWinner.timeSpent | number:'1.1-1' }} seconds</p>
        <p class="mb-0">You are the fastest player and the champion!</p>
      </div>
      
      <div class="alert alert-info text-center" *ngIf="!isWinner">
        <i class="bi bi-flag-fill me-2" style="font-size: 2.5rem;"></i>
        <h3 class="mb-3">Game Over</h3>
        <h4 class="mb-2">{{ gameWinner.username }} Wins!</h4>
        <p class="mb-1">They answered the final question in {{ gameWinner.timeSpent | number:'1.1-1' }} seconds</p>
        <p class="mb-0">Better luck next time!</p>
      </div>
    </div>

    <!-- Regular Score Display (when no fastest winner) -->
    <div *ngIf="!gameWinner && quizResult">
      <!-- Results Header -->
      <div class="result-header" [ngClass]="getScoreClass(quizResult?.score || 0)">
        <h2>Game Over!</h2>
        <p>Your Score: {{ quizResult?.score || 0 }}%</p>
      </div>
      
      <!-- Score Display -->
      <div class="result-score">
        <div class="score-circle" [ngClass]="getScoreClass(quizResult?.score || 0)">
          <span class="score-value">{{ quizResult?.score || 0 }}%</span>
          <div class="score-circle-bg"></div>
          <svg class="score-circle-chart" viewBox="0 0 36 36">
            <path class="score-circle-bg"
                  d="M18 2.0845
                     a 15.9155 15.9155 0 0 1 0 31.831
                     a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  stroke="#eee"
                  stroke-width="3"/>
            <path class="score-circle-fill"
                  d="M18 2.0845
                     a 15.9155 15.9155 0 0 1 0 31.831
                     a 15.9155 15.9155 0 0 1 0 -31.831"
                  fill="none"
                  [attr.stroke-dasharray]="(quizResult?.score || 0) + ',100'"
                  stroke="currentColor"
                  stroke-width="3"/>
          </svg>
        </div>
      </div>

      <!-- Result Details -->
      <div class="result-details">
        <div class="result-detail">
          <div class="detail-label">Correct Answers</div>
          <div class="detail-value correct">{{ quizResult?.correctAnswers || 0 }} / {{ quizResult?.totalQuestions || 0 }}</div>
        </div>
        <div class="result-detail">
          <div class="detail-label">Incorrect Answers</div>
          <div class="detail-value incorrect">{{ (quizResult?.totalQuestions || 0) - (quizResult?.correctAnswers || 0) }} / {{ quizResult?.totalQuestions || 0 }}</div>
        </div>
        <div class="result-detail">
          <div class="detail-label">Time Spent</div>
          <div class="detail-value">{{ quizResult?.timeSpent || 0 }} seconds</div>
        </div>
      </div>
      
      <div class="result-mode">
        <i class="bi bi-trophy-fill me-2"></i>
        <span>Your score has been submitted to the leaderboard!</span>
      </div>
    </div>

    <!-- Fallback if neither winner nor quizResult -->
    <div *ngIf="!gameWinner && !quizResult" class="text-center">
      <div class="alert alert-warning">
        <h3>Game Over</h3>
        <p>The quiz has ended. No winner was determined.</p>
      </div>
    </div>
    
    <div class="result-actions">
      <button class="btn btn-primary me-2" type="button" (click)="restartQuiz()">
        <i class="bi bi-arrow-repeat me-2"></i>Play Again
      </button>
      <button class="btn btn-outline-secondary" type="button" (click)="navigateToHome()">
        <i class="bi bi-house-door me-2"></i>Back to Home
      </button>
    </div>
  </div>
</div>

<!-- Quiz Results Section for Solo Mode -->
<div class="quiz-container" *ngIf="quizFinished && quizResult && mode === 'solo'">
  <div class="quiz-result-card">
    <!-- Score Reveal Section -->
    <div class="result-header" [ngClass]="getScoreClass(quizResult?.score || 0)">
      <h2>Quiz Completed!</h2>
      <p>Your Final Score: {{ quizResult?.score || 0 }}%</p>
    </div>
    
    <!-- Score Display -->
    <div class="result-score">
      <div class="score-circle" [ngClass]="getScoreClass(quizResult?.score || 0)">
        <span class="score-value">{{ quizResult?.score || 0 }}%</span>
        <div class="score-circle-bg"></div>
        <svg class="score-circle-chart" viewBox="0 0 36 36">
          <path class="score-circle-bg"
                d="M18 2.0845
                   a 15.9155 15.9155 0 0 1 0 31.831
                   a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke="#eee"
                stroke-width="3"/>
          <path class="score-circle-fill"
                d="M18 2.0845
                   a 15.9155 15.9155 0 0 1 0 31.831
                   a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                [attr.stroke-dasharray]="(quizResult?.score || 0) + ',100'"
                stroke="currentColor"
                stroke-width="3"/>
        </svg>
      </div>
    </div>

    <!-- Result Details -->
    <div class="result-details">
      <div class="result-detail">
        <div class="detail-label">Correct Answers</div>
        <div class="detail-value correct">{{ quizResult?.correctAnswers || 0 }} / {{ quizResult?.totalQuestions || 0 }}</div>
      </div>
      <div class="result-detail">
        <div class="detail-label">Incorrect Answers</div>
        <div class="detail-value incorrect">{{ (quizResult?.totalQuestions || 0) - (quizResult?.correctAnswers || 0) }} / {{ quizResult?.totalQuestions || 0 }}</div>
      </div>
      <div class="result-detail">
        <div class="detail-label">Time Spent</div>
        <div class="detail-value">{{ quizResult?.timeSpent || 0 }} seconds</div>
      </div>
    </div>
    
    <!-- Performance Message -->
    <div class="result-mode" [ngClass]="getScoreClass(quizResult?.score || 0)">
      <i class="bi" [ngClass]="{
        'bi-emoji-smile-fill': (quizResult?.score || 0) >= 80,
        'bi-emoji-neutral-fill': (quizResult?.score || 0) >= 50 && (quizResult?.score || 0) < 80,
        'bi-emoji-frown-fill': (quizResult?.score || 0) < 50
      }"></i>
      <span>
        <span *ngIf="(quizResult?.score || 0) >= 80">Excellent! You're a quiz master! üéâ</span>
        <span *ngIf="(quizResult?.score || 0) >= 50 && (quizResult?.score || 0) < 80">Good job! Keep practicing! üëç</span>
        <span *ngIf="(quizResult?.score || 0) < 50">Nice try! Practice makes perfect! üí™</span>
      </span>
    </div>
    
    <div class="result-actions">
      <button class="btn btn-primary me-2" type="button" (click)="restartQuiz()">
        <i class="bi bi-arrow-repeat me-2"></i>Try Again
      </button>
      <button class="btn btn-outline-secondary" type="button" (click)="navigateToHome()">
        <i class="bi bi-house-door me-2"></i>Back to Home
      </button>
    </div>
  </div>
</div>

<!-- Active Quiz Section -->
<div class="quiz-container" *ngIf="quizStarted && !quizFinished && !gameOver">
  <div class="quiz-card">
    
    <!-- WATCH MODE BANNER -->
    <div *ngIf="watchMode" class="watch-mode-banner alert alert-warning mb-3">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi bi-eye-fill me-2 fs-5"></i>
          <div>
            <h5 class="mb-1">üëÄ Watch Mode Activated</h5>
            <p class="mb-0">You've been eliminated. You can watch the quiz but cannot participate.</p>
          </div>
        </div>
        <div class="watch-mode-badge">
          <span class="badge bg-warning text-dark">SPECTATOR</span>
        </div>
      </div>
    </div>
    
    <!-- IMMEDIATE ELIMINATION FEEDBACK - NEW SECTION -->
   <!--  <div *ngIf="watchMode && timeRemaining > 0" class="alert alert-danger mb-3" role="alert">
      <div class="d-flex align-items-center">
        <i class="bi bi-x-circle-fill me-2"></i>
        <div>
          <h5 class="alert-heading mb-1">You've Been Eliminated!</h5>
          <p class="mb-0">{{ eliminationMessage }}</p>
          <p class="mb-0 mt-1"><small>Waiting for time to expire to see the correct answer...</small></p>
        </div>
      </div>
    </div> -->
    
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">
        <span *ngIf="mode === 'solo'">Solo Quiz</span>
        <span *ngIf="mode === 'online'">Online Quiz</span>
        <!-- Watch mode indicator in title -->
        <span *ngIf="watchMode" class="ms-2 badge bg-warning text-dark fs-6">Watch Mode</span>
      </h2>
    </div>
    
    <div class="quiz-header">
      <div class="quiz-progress">
        <div class="progress">
          <div class="progress-bar" 
               [style.width]="currentProgress + '%'"
               role="progressbar" 
               [attr.aria-valuenow]="currentQuestionIndex + 1" 
               aria-valuemin="0" 
               [attr.aria-valuemax]="totalQuestionsCount">
          </div>
        </div>
        <div class="question-counter">
          Question {{ currentQuestionIndex + 1 }} of {{ totalQuestionsCount }}
          <!-- Watch mode indicator in progress -->
          <span *ngIf="watchMode" class="ms-2 badge bg-warning text-dark fs-7">Spectator</span>
        </div>
      </div>
      <div class="d-flex align-items-center">
        <!-- Timer for online mode ONLY -->
        <div class="quiz-timer me-3" *ngIf="mode === 'online'" [ngClass]="{
          'text-warning': timeRemaining <= 15 && timeRemaining > 5,
          'text-danger': timeRemaining <= 5,
          'watch-mode-timer': watchMode
        }">
          <i class="bi bi-clock-history me-1"></i>
          Q{{ currentQuestionIndex + 1 }}: {{ timeRemaining | number:'2.0-0' }}s
          <!-- Watch mode indicator in timer -->
          <span *ngIf="watchMode" class="ms-1 badge bg-warning text-dark fs-7">üëÄ</span>
        </div>
        
        <div class="quiz-mode-badge" [ngClass]="mode === 'solo' ? 'solo' : 'online'">
          {{ mode === 'solo' ? 'Solo Mode' : 'Online Mode' }}
          <!-- Watch mode indicator in mode badge -->
          <span *ngIf="watchMode" class="ms-1">‚Ä¢ Spectator</span>
        </div>
      </div>
    </div>
    
    <div class="question-container" *ngIf="questions[currentQuestionIndex]">
      <!-- Online Mode Only Elements -->
      <div *ngIf="mode === 'online'">
        
        <!-- FINAL QUESTION WARNING -->
        <div class="alert alert-warning" *ngIf="isFinalQuestion" role="alert">
          <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
              <h5 class="alert-heading mb-1" *ngIf="!watchMode">Final Question!</h5>
              <h5 class="alert-heading mb-1" *ngIf="watchMode">Final Question - Winner Announcement Soon!</h5>
              <p class="mb-0" *ngIf="!watchMode">First correct answer wins the entire game! Be quick!</p>
              <p class="mb-0" *ngIf="watchMode">Waiting to see who answers first and wins the game!</p>
            </div>
          </div>
        </div>

        <!-- QUIZ STATUS INFORMATION -->
        <div class="quiz-status-info">
          <!-- Enhanced Watch Mode Status -->
          <div class="status-item watch-mode-status" *ngIf="watchMode">
            <i class="bi bi-eye-fill text-warning"></i>
            <span>Watch Mode - Spectating</span>
          </div>
          
          <!-- Wrong Answer Waiting for Time Expiry -->

        <!--   <div class="status-item" *ngIf="isAnswerCorrect === false && !watchMode && timeRemaining > 0">
            <i class="bi bi-hourglass text-danger"></i>
            <span>Wrong Answer - Waiting for time to expire</span>
          </div> -->
          
          <!-- Time Expired - Showing Answer -->
          <div class="status-item" *ngIf="watchMode && timeRemaining <= 0 && showAnswerFeedback">
            <i class="bi bi-lightbulb-fill text-success"></i>
            <span>Showing Correct Answer</span>
          </div>
          
          <!-- Proceeding to Next Question -->
          <div class="status-item" *ngIf="watchMode && loading && !isFinalQuestion">
            <i class="bi bi-arrow-right-circle text-info"></i>
            <span>Proceeding to Next Question...</span>
          </div>
          
          <!-- Waiting for Winner -->
          <div class="status-item" *ngIf="watchMode && loading && isFinalQuestion">
            <i class="bi bi-trophy text-warning"></i>
            <span>Determining Winner...</span>
          </div>
          
          <div class="status-item" *ngIf="timeRemaining <= 5 && timeRemaining > 0 && !watchMode">
            <i class="bi bi-clock text-danger"></i>
            <span>Time almost up!</span>
          </div>
          
          <div class="status-item" *ngIf="answerSubmitted && timeRemaining > 0 && !watchMode && isAnswerCorrect !== false">
            <i class="bi bi-check-circle text-success"></i>
            <span>Answer Submitted</span>
          </div>
        </div>

        <!-- WRONG ANSWER WAITING MESSAGE -->
      <!--   <div *ngIf="isAnswerCorrect === false && !watchMode && timeRemaining > 0" class="alert alert-danger" role="alert">
          <div class="d-flex align-items-center">
            <i class="bi bi-hourglass-top me-2"></i>
            <div>
              <h5 class="alert-heading mb-1">Wrong Answer!</h5>
              <p class="mb-0">You will be eliminated when the time expires. The correct answer will be revealed then.</p>
            </div>
          </div>
        </div>
 -->
        <!-- WATCH MODE TIME EXPIRED MESSAGE -->
        <div class="alert alert-info" *ngIf="watchMode && timeRemaining <= 0 && showAnswerFeedback" role="alert">
          <div class="d-flex align-items-center">
            <i class="bi bi-lightbulb-fill me-2"></i>
            <div>
              <h5 class="alert-heading mb-1">Correct Answer Revealed</h5>
              <p class="mb-0" *ngIf="!isFinalQuestion">
                Proceeding to next question in 2 seconds...
              </p>
              <p class="mb-0" *ngIf="isFinalQuestion">
                Final question completed! Waiting for winner announcement...
              </p>
            </div>
          </div>
        </div>

        <!-- REGULAR PLAYER MESSAGES -->
        <div *ngIf="!watchMode && isAnswerCorrect !== false">
          <div *ngIf="showAnswerFeedback && !isFinalQuestion" class="alert alert-info">
            <div class="d-flex align-items-center">
              <i class="bi bi-clock-history me-2"></i>
              <div>
                <h5 class="alert-heading mb-1">Advancing to next question...</h5>
                <p class="mb-0">Next question starting shortly.</p>
              </div>
            </div>
          </div>

          <div class="alert alert-info" *ngIf="timeRemaining <= 0 && isFinalQuestion && !quizFinished" role="alert">
            <div class="d-flex align-items-center">
              <i class="bi bi-clock-fill me-2"></i>
              <div>
                <h5 class="alert-heading mb-1">Time's Up! Determining Winner...</h5>
                <p class="mb-0">Waiting for fastest correct answer...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <h3 class="question-text">{{ questions[currentQuestionIndex].question }}</h3>
      
      <!-- OPTIONS CONTAINER -->
      <div class="options-container" [class.watch-mode-container]="watchMode">
        <div *ngFor="let option of questions[currentQuestionIndex].options; let i = index" 
             class="option" 
             [class.selected]="selectedAnswer === i"
             [class.correct]="showAnswerFeedback && currentCorrectAnswerIndex === i"
             [class.incorrect]="showAnswerFeedback && selectedAnswer === i && currentCorrectAnswerIndex !== i"
             [class.watch-mode-correct]="watchMode && showAnswerFeedback && currentCorrectAnswerIndex === i"
             [class.watch-mode-option]="watchMode"
             [class.disabled]="(mode === 'online' && (watchMode || timeRemaining <= 0)) || (mode === 'solo' && answerSubmitted)"
             (click)="selectAnswer(i)">
          
          <div class="option-letter">{{ getLetter(i) }}</div>
          <div class="option-text">{{ option.text }}</div>
          
          <!-- Answer feedback -->
          <div class="answer-feedback" *ngIf="showAnswerFeedback">
            <i class="bi" [ngClass]="{
              'bi-check-circle-fill text-success': currentCorrectAnswerIndex === i,
              'bi-x-circle-fill text-danger': selectedAnswer === i && currentCorrectAnswerIndex !== i
            }"></i>
          </div>
          
          <!-- Online mode specific overlays -->
          <div *ngIf="mode === 'online'">
            <!-- Watch Mode Correct Answer Indicator -->
            <div class="watch-mode-correct-indicator" 
                 *ngIf="watchMode && showAnswerFeedback && currentCorrectAnswerIndex === i">
              <i class="bi bi-star-fill"></i>
              <span>Correct Answer</span>
            </div>

            <!-- Watch Mode Overlay - Shows when in watch mode and time is still running -->
            <div class="watch-mode-overlay" *ngIf="watchMode && timeRemaining > 0 && !showAnswerFeedback">
              <i class="bi bi-eye"></i>
              <span>View Only - Cannot Answer</span>
            </div>

            <!-- Time Expired Overlay -->
            <div class="time-expired-overlay" *ngIf="timeRemaining <= 0 && !showAnswerFeedback && !watchMode">
              <i class="bi bi-hourglass-split"></i>
              <span>Time's Up!</span>
            </div>

            <!-- Watch Mode Time Expired - Shows correct answer -->

           <!--  <div class="watch-mode-time-expired" *ngIf="watchMode && timeRemaining <= 0 && showAnswerFeedback && currentCorrectAnswerIndex === i">
              <i class="bi bi-lightbulb-fill"></i>
              <span>Correct Answer</span>
            </div> -->
          </div>
        </div>
      </div>

      <!-- Solo Mode Immediate Feedback -->
      <div *ngIf="mode === 'solo' && showAnswerFeedback" class="solo-feedback-message" [ngClass]="feedbackClass">
        <i class="bi" [ngClass]="{
          'bi-check-circle-fill': isAnswerCorrect,
          'bi-x-circle-fill': !isAnswerCorrect
        }"></i>
        <span>{{ feedbackMessage }}</span>
        <small class="d-block mt-1">Moving to next question...</small>
      </div>

      <!-- Correct answer message for both modes -->
      <div *ngIf="showAnswerFeedback && currentCorrectAnswerIndex !== null && questions[currentQuestionIndex]" 
           class="correct-answer-message alert alert-success">
        <div class="d-flex align-items-center">
          <i class="bi bi-lightbulb-fill me-2"></i>
          <div>
            <h5 class="alert-heading mb-1">Correct Answer</h5>
            <p class="mb-0">
              <strong>{{ getLetter(currentCorrectAnswerIndex) }}. {{ questions[currentQuestionIndex].options[currentCorrectAnswerIndex]?.text }}</strong>
            </p>
          </div>
        </div>
      </div>

      <!-- Watch Mode Progression Info -->
      <div *ngIf="watchMode && showAnswerFeedback && !isFinalQuestion" class="watch-mode-progression alert alert-light mt-3">
        <div class="d-flex align-items-center justify-content-center">
          <i class="bi bi-arrow-right-circle me-2 text-info"></i>
          <span>Automatically advancing to next question...</span>
        </div>
      </div>

      <!-- Final Question Winner Waiting -->
      <div *ngIf="watchMode && isFinalQuestion && timeRemaining <= 0" class="alert alert-warning mt-3">
        <div class="d-flex align-items-center justify-content-center">
          <i class="bi bi-trophy me-2 text-warning"></i>
          <span>Final question completed! The winner will be announced shortly...</span>
        </div>
      </div>
    </div>

    <!-- Loading state for online mode -->
    <div class="waiting-container" *ngIf="loading && mode === 'online'">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4 *ngIf="isFinalQuestion && timeRemaining <= 0 && !watchMode">Determining winner...</h4>
      <h4 *ngIf="isFinalQuestion && timeRemaining <= 0 && watchMode">Waiting for winner announcement...</h4>
      <h4 *ngIf="!isFinalQuestion && !watchMode">Loading next question...</h4>
      <h4 *ngIf="!isFinalQuestion && watchMode">Preparing next question for viewing...</h4>
    </div>
  </div>
</div>

<!-- Global Error Display -->
<div *ngIf="error && !quizStarted && !quizFinished" class="alert alert-danger" role="alert">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  {{ error }}
</div>