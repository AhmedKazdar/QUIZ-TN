<div class="quiz-container" *ngIf="!quizStarted && !quizFinished && !modeFromRoute">
  <div class="quiz-start-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Select Quiz Mode</h2>
      <button class="btn btn-outline-secondary btn-sm" (click)="navigateToHome()">
        <i class="bi bi-house-door me-1"></i> Return Home
      </button>
    </div>
    <p>Choose between practice mode to test your knowledge or online mode to compete with others!</p>
    
    <div class="quiz-modes">
      <div class="quiz-mode-card" (click)="startQuiz('solo')" [class.loading]="loading && mode === 'solo'">
        <div class="mode-icon">
          <i class="bi bi-journal-text"></i>
        </div>
        <h3>Solo Mode</h3>
        <p>Test your knowledge at your own pace with instant feedback.</p>
        <button class="btn btn-primary" [disabled]="loading">
          <span *ngIf="loading && mode === 'solo'" class="spinner-border spinner-border-sm me-2"></span>
          Start Solo
        </button>
      </div>
      
      <div class="quiz-mode-card" (click)="startQuiz('online')" [class.loading]="loading && mode === 'online'">
        <div class="mode-icon">
          <i class="bi bi-globe"></i>
        </div>
        <h3>Online Mode</h3>
        <p>Compete with others and get ranked on the leaderboard!</p>
        <button class="btn btn-primary" [disabled]="loading">
          <span *ngIf="loading && mode === 'online'" class="spinner-border spinner-border-sm me-2"></span>
          Start Online Quiz
        </button>
      </div>
    </div>
    
    <button class="btn btn-outline-secondary mt-4" routerLink="/home">
      <i class="bi bi-arrow-left me-2"></i>Back to Home
    </button>
  </div>
</div>

<div class="quiz-container" *ngIf="quizStarted && !quizFinished">
  <div class="quiz-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">
        <span *ngIf="mode === 'solo'">Solo Quiz</span>
        <span *ngIf="mode === 'online'">Online Quiz</span>
      </h2>
     <!--  <button class="btn btn-outline-secondary btn-sm" (click)="navigateToHome()">
        <i class="bi bi-house-door me-1"></i> Return Home
      </button> -->
    </div>
    <div class="quiz-header">
      <div class="quiz-progress">
        <div class="progress">
          <div class="progress-bar" 
               [style.width]="((currentQuestionIndex + 1) / questions.length * 100) + '%'"
               role="progressbar" 
               [attr.aria-valuenow]="currentQuestionIndex + 1" 
               aria-valuemin="0" 
               [attr.aria-valuemax]="questions.length">
          </div>
        </div>
        <div class="question-counter">
          Question {{ currentQuestionIndex + 1 }} of {{ questions.length }}
        </div>
      </div>
      
      <div class="d-flex align-items-center">
        <!-- Timer for online mode -->
        <div class="quiz-timer me-3" *ngIf="mode === 'online'" [ngClass]="{
          'text-warning': timeRemaining <= 15 && timeRemaining > 5,
          'text-danger': timeRemaining <= 5
        }">
          <i class="bi bi-clock-history me-1"></i>
          {{ timeRemaining | number:'2.0-0' }}s
        </div>
        
        <div class="quiz-mode-badge" [ngClass]="mode === 'solo' ? 'solo' : 'online'">
          {{ mode === 'solo' ? 'Solo Mode' : 'Online Mode' }}
        </div>
      </div>
    </div>
    
    <div class="question-container" *ngIf="questions[currentQuestionIndex]">
      <div class="alert alert-warning" *ngIf="watchMode" role="alert">
        <div class="d-flex align-items-center">
          <i class="bi bi-eye-fill me-2"></i>
          <div>
            <h5 class="alert-heading mb-1">Watch Mode Activated</h5>
            <p class="mb-0">You've selected a wrong answer. You can continue watching the quiz but can no longer participate.</p>
          </div>
        </div>
      </div>
      <h3 class="question-text">{{ questions[currentQuestionIndex].textequestion }}</h3>
      
      <!-- Waiting message for online mode -->
      <div *ngIf="mode === 'online' && waitingForAnswer" class="waiting-container text-center my-4">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <h4>Waiting for other players...</h4>
      </div>

      <div class="options-container" [class.waiting]="mode === 'online' && waitingForAnswer">
        <div *ngFor="let option of questions[currentQuestionIndex].options; let i = index" 
             class="option" 
             [class.selected]="selectedAnswer === i"
             [class.answered]="answers[currentQuestionIndex] !== null && answers[currentQuestionIndex] !== undefined"
             [class.correct]="selectedAnswer === i && i === questions[currentQuestionIndex].correctAnswer"
             [class.incorrect]="selectedAnswer === i && i !== questions[currentQuestionIndex].correctAnswer"
             [class.disabled]="(answers[currentQuestionIndex] !== null && answers[currentQuestionIndex] !== undefined) || (mode === 'online' && waitingForAnswer)"
             (click)="selectAnswer(i)">
          <div class="option-number">{{ i + 1 }}</div>
          <div class="option-text">{{ option }}</div>
          <div class="answer-feedback" *ngIf="(selectedAnswer !== null && !waitingForAnswer) || quizFinished">
            <i class="bi" [ngClass]="{
              'bi-check-circle-fill text-success': i === questions[currentQuestionIndex].correctAnswer,
              'bi-x-circle-fill text-danger': selectedAnswer === i && i !== questions[currentQuestionIndex].correctAnswer
            }"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="quiz-actions">
      <div></div> <!-- Empty div for flex spacing -->
      
      <!-- Only show Next button in solo mode -->
      <button *ngIf="mode === 'solo'" 
              class="btn btn-primary" 
              (click)="nextQuestion()" 
              [disabled]="selectedAnswer === null || loading">
        <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
        {{ currentQuestionIndex === questions.length - 1 ? 'Finish Quiz' : 'Next Question' }}
        <i class="bi bi-arrow-right ms-2"></i>
      </button>
    </div>
  </div>
</div>

<div class="quiz-container" *ngIf="quizFinished && quizResult">
  <div class="quiz-result-card">
   <!--  <div class="text-end mb-3">
      <button class="btn btn-outline-secondary btn-sm" (click)="navigateToHome()">
        <i class="bi bi-house-door me-1"></i> Return Home
      </button>
    </div> -->
    <div class="result-header" [ngClass]="getScoreClass(quizResult?.score || 0)">
      <h2 *ngIf="isQuizCompletedSuccessfully()">Quiz Completed!</h2>
      <h2 *ngIf="!isQuizCompletedSuccessfully()">Game Over!</h2>
      <p>Your Score: {{ quizResult?.score || 0 }}%</p>
    <div class="result-score">
      <div class="score-circle" [ngClass]="getScoreClass(quizResult?.score || 0)">
        <span class="score-value">{{ quizResult?.score || 0 }}%</span>
        <div class="score-circle-bg"></div>
        <svg class="score-circle-chart" viewBox="0 0 36 36">
          <path class="score-circle-bg"
                d="M18 2.0845
                   a 15.9155 15.9155 0 0 1 0 31.831
                   a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke="#eee"
                stroke-width="3"/>
          <path class="score-circle-fill"
                d="M18 2.0845
                   a 15.9155 15.9155 0 0 1 0 31.831
                   a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                [attr.stroke-dasharray]="(quizResult?.score || 0) + ',100'"
                stroke="currentColor"
                stroke-width="3"/>
        </svg>
      </div>
    </div>
    
    <div class="result-details">
      <div class="result-detail">
        <div class="detail-label">Correct Answers</div>
        <div class="detail-value correct">{{ quizResult?.correctAnswers || 0 }} / {{ quizResult?.totalQuestions || 0 }}</div>
      </div>
      <div class="result-detail">
        <div class="detail-label">Incorrect Answers</div>
        <div class="detail-value incorrect">{{ (quizResult?.totalQuestions || 0) - (quizResult?.correctAnswers || 0) }} / {{ quizResult?.totalQuestions || 0 }}</div>
      </div>
      <div class="result-detail">
        <div class="detail-label">Time Spent</div>
        <div class="detail-value">{{ quizResult.timeSpent || 0 }} seconds</div>
      </div>
    </div>
    
    <div class="result-actions">
      <button class="btn btn-primary me-2" type="button" (click)="restartQuiz()">
        <i class="bi bi-arrow-repeat me-2"></i>Try Again
      </button>
      <button class="btn btn-outline-secondary" type="button" routerLink="/home">
        <i class="bi bi-house-door me-2"></i>Back to Home
      </button>
    </div>
    
    <div class="result-mode" *ngIf="mode === 'online'">
      <i class="bi bi-trophy-fill me-2"></i>
      Your score has been submitted to the leaderboard!
    </div>
  </div>
</div>

<div *ngIf="error" class="alert alert-danger" role="alert">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  {{ error }}
</div>
